name: Run ansible

on:
  workflow_dispatch:

env:
  ANSIBLE_COLLECTIONS_PATH: /tmp/collections

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.0
        with:
          repository: ${{ secrets.ENV_REPOSITORY }}
          ref: main
          token: ${{ secrets.GH_BOT_WORKFLOW_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible ansible-lint jmespath proxmoxer

      - name: Install required collections
        run: |
          mkdir -p $ANSIBLE_COLLECTIONS_PATH
          ansible-galaxy collection install -r ansible/requirements.yml -p $ANSIBLE_COLLECTIONS_PATH

      - name: Create vault file from secrets
        run: |
          mkdir -p ansible/vars
          cat > ansible/vars/vault.yml << EOF
          proxmox_host: ${{ secrets.ENV_PROXMOX_HOST }}
          proxmox_api_user: ${{ secrets.ENV_PROXMOX_USER }}
          proxmox_api_token_id: ${{ secrets.ENV_PROXMOX_TOKEN_ID }}
          proxmox_api_token_secret: ${{ secrets.ENV_PROXMOX_TOKEN_SECRET }}
          postgres_password: ${{ secrets.ENV_POSTGRES_PASSWORD }}
          EOF

      - name: Run Ansible playbook
        env:
          PROXMOX_HOST: ${{ secrets.ENV_PROXMOX_HOST }}
          PROXMOX_PORT: ${{ secrets.ENV_PROXMOX_PORT }}
          PROXMOX_NODE: ${{ secrets.ENV_PROXMOX_NODE }}
          PROXMOX_USER: ${{ secrets.ENV_PROXMOX_USER }}
          PROXMOX_TOKEN_ID: ${{ secrets.ENV_PROXMOX_TOKEN_ID }}
          PROXMOX_TOKEN_SECRET: ${{ secrets.ENV_PROXMOX_TOKEN_SECRET }}
          ANSIBLE_COLLECTIONS_PATH: ${{ env.ANSIBLE_COLLECTIONS_PATH }}
        run: |
          cd ansible
          ansible-playbook playbook.yml \
            -e "proxmox_host=$PROXMOX_HOST" \
            -e "proxmox_node=$PROXMOX_NODE" \
            -i inventory/proxmox.yml

      - name: Clean up vault file
        if: always()
        run: rm -f ansible/vars/vault.yml

      - name: Handle deployment failure
        if: failure()
        run: |
          echo "Deployment failed. Possible reasons:"
          echo "1. Multiple containers with 'postgres' tag found"
          echo "2. Disk size mismatch (trying to shrink disk)"
          echo "3. Proxmox API connection issue"
          echo "4. PostgreSQL healthcheck failed"
          echo "5. Invalid credentials or permissions"
          exit 1
