name: Run ansible

on:
  workflow_dispatch:

env:
  ANSIBLE_COLLECTIONS_PATH: /tmp/collections

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.0
        with:
          repository: ${{ secrets.ENV_REPOSITORY }}
          ref: ansible-postgres
          token: ${{ secrets.GH_BOT_WORKFLOW_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ansible/requirements.txt
          sudo apt install -y yq

      - name: Install required collections
        run: |
          mkdir -p $ANSIBLE_COLLECTIONS_PATH
          ansible-galaxy collection install -r ansible/requirements.yml -p $ANSIBLE_COLLECTIONS_PATH

      - name: Prepare hash
        id: hashed_password
        env:
          PROXMOX_PGBACKWEBPASS: ${{ secrets.ENV_PROXMOX_PGBACKWEBPASS }}
        run: |
          HASHED_PASSWORD=$(python ansible/files/bcrypt_hash.py <<< "$PROXMOX_PGBACKWEBPASS")
          sed -i "s|'HASH_VAR'|'$HASHED_PASSWORD'|g" ansible/files/pgbackweb_init.sql

      - name: Prepare certs
        run: |
          mkdir -p ansible/certs
          cp certs/${{ secrets.ENV_PROXMOX_DOMAIN }}/cert.pem ansible/certs/${{ secrets.ENV_PROXMOX_DOMAIN }}.crt
          cp certs/${{ secrets.ENV_PROXMOX_DOMAIN }}/privkey.pem.enc ansible/certs/${{ secrets.ENV_PROXMOX_DOMAIN }}.key.enc
          openssl enc -aes-256-cbc -salt -d -md sha256 -in ansible/certs/${{ secrets.ENV_PROXMOX_DOMAIN }}.key.enc -out ansible/certs/${{ secrets.ENV_PROXMOX_DOMAIN }}.key -k ${{ secrets.ENV_CERTBOT_PASS }} 
          rm -f ansible/certs/50-main.key.enc

      - name: Create vault file from secrets
        run: |
          mkdir -p ansible/vars
          cat > ansible/vars/vault.yml << EOF
          proxmox_host: ${{ secrets.ENV_PROXMOX_HOST }}
          proxmox_port: ${{ secrets.ENV_PROXMOX_PORT }}
          proxmox_api_user: ${{ secrets.ENV_PROXMOX_USER }}
          proxmox_api_token_id: ${{ secrets.ENV_PROXMOX_TOKEN_ID }}
          proxmox_api_token_secret: ${{ secrets.ENV_PROXMOX_TOKEN_SECRET }}
          postgres_password: ${{ secrets.ENV_POSTGRES_PASSWORD }}
          proxmox_ssh_private_key: ${{ secrets.ENV_PROXMOX_SSH_PRIVATE_KEY }}
          certbot_pass: ${{ secrets.ENV_CERTBOT_PASS }}
          gitea_admin_password: ${{ secrets.ENV_GITEA_PASSWORD }}
          EOF

      - name: Run Ansible playbook
        env:
          PROXMOX_HOST: ${{ secrets.ENV_PROXMOX_HOST }}
          PROXMOX_PORT: ${{ secrets.ENV_PROXMOX_PORT }}
          PROXMOX_NODE: ${{ secrets.ENV_PROXMOX_NODE }}
          PROXMOX_USER: ${{ secrets.ENV_PROXMOX_USER }}
          PROXMOX_TOKEN_ID: ${{ secrets.ENV_PROXMOX_TOKEN_ID }}
          PROXMOX_TOKEN_SECRET: ${{ secrets.ENV_PROXMOX_TOKEN_SECRET }}
          ANSIBLE_COLLECTIONS_PATH: ${{ env.ANSIBLE_COLLECTIONS_PATH }}
          PROXMOX_VALIDATE_CERTS: false
        run: |
          cd ansible
          ansible-playbook playbook.yml \
            -i inventory/proxmox.yml \
            -vvvv

      - name: Run Ansible certificate playbook
        env:
          ANSIBLE_COLLECTIONS_PATH: ${{ env.ANSIBLE_COLLECTIONS_PATH }}
          PROXMOX_VALIDATE_CERTS: false
        run: |
          cd ansible
          ansible-playbook playbook-certs.yml \
            -i inventory/proxmox.yml \
            -vvvv

      - name: Clean up vault file
        if: always()
        run: |
          rm -f ansible/vars/vault.yml
          rm -rf ansible/certs

      - name: Handle deployment failure
        if: failure()
        run: |
          echo "Deployment failed. Possible reasons:"
          echo "1. Multiple containers with 'postgres' tag found"
          echo "2. Disk size mismatch (trying to shrink disk)"
          echo "3. Proxmox API connection issue"
          echo "4. PostgreSQL healthcheck failed"
          echo "5. Invalid credentials or permissions"
          exit 1

      - name: Get commit params
        id: commit-params
        run: |
          # Create commit params
          echo "date=$(date +'%F %T')" >> $GITHUB_OUTPUT
          # Author & email from last commit
          echo "author=$(git log -n 1 --pretty=format:%an)" >> $GITHUB_OUTPUT
          echo "email=$(git log -n 1 --pretty=format:%ae)" >> $GITHUB_OUTPUT

      - name: Commit changes
        uses: EndBug/add-and-commit@v9.1.4
        with:
          author_name: ${{ steps.commit-params.outputs.author }}
          author_email: ${{ steps.commit-params.outputs.email }}
          add: './ansible/settings.yml'
          new_branch: ansible-postgres
          message: 'chore(ansible): ansible action run at `${{ steps.commit-params.outputs.date }}`'
          github_token: ${{ secrets.GITHUB_TOKEN  }}
